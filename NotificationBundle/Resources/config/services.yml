services:

    trinity.notification.entity_converter:
        class: Trinity\NotificationBundle\Notification\EntityConverter
        arguments:
            - "@trinity.notification.annotations.utils"
            - "@logger"
            - "%trinity.notification.entity_id_field%"


    trinity.notification.services.notification_parser:
        class: Trinity\NotificationBundle\Notification\NotificationParser
        arguments:
            - "@logger"
            - "@trinity.notification.entity_converter"
            - "%trinity.notification.entity_id_field%"
            - "%trinity.notification.is_client%"
            - "%trinity.notification.create_new_entity%"
        calls:
            - [setEntityManager, ["@doctrine.orm.entity_manager"]]


    trinity.notification.annotations.utils:
        class: Trinity\NotificationBundle\Notification\AnnotationsUtils


    trinity.notification.utils:
        arguments:
            - "@trinity.notification.annotations.utils"
        class: Trinity\NotificationBundle\Notification\Annotations\NotificationUtils


    trinity.notification.manager:
        class: Trinity\NotificationBundle\Notification\NotificationManager
        arguments:
            - "@event_dispatcher"
            - "%trinity.notification.server_notify_url%"


    trinity.notification.entity_listener:
        class: Trinity\NotificationBundle\EventListener\EntityListener
        arguments:
            - "@trinity.notification.manager"
            - "@trinity.notification.utils"
            - "%trinity.notification.is_client%"
        tags:
            - { name: doctrine.event_listener, event: onFlush, priority: 255 }
            - { name: doctrine.event_listener, event: postUpdate,  priority: 200 }
            - { name: doctrine.event_listener, event: postPersist, priority: 200 }
        calls:
            - [setRequestStack, [@request_stack]]


    trinity.notification.driver.api:
        class: Trinity\NotificationBundle\Drivers\ApiDriver\ApiDriver
        arguments:
            - "@event_dispatcher"
            - "@trinity.notification.entity_converter"
            - "@trinity.notification.utils"
            - "@security.token_storage"
        tags:
            - { name: trinity.notification.driver }


    trinity.notification.driver.client_api:
        class: Trinity\NotificationBundle\Drivers\ClientApiDriver\ClientApiDriver
        arguments:
            - "@event_dispatcher"
            - "@trinity.notification.entity_converter"
            - "@trinity.notification.utils"
            - "%trinity.notification.server_oauth_url%"
            - "%trinity.notification.server_client_secret%"
            - "%trinity.notification.server_client_id%"
        tags:
            - { name: trinity.notification.driver }
